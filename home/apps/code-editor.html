<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Editor</title>
<style>
:root {
  --bg: #0a0a0a;
  --fg: #e0e0e0;
  --accent: #61DAFB;
  --surface: #1a1a1a;
  --border: #333;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--fg);
  display: flex;
  flex-direction: column;
  height: 100vh;
}
.toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}
.toolbar select, .toolbar input {
  background: var(--bg);
  color: var(--fg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 13px;
}
.toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
.toolbar input { flex: 1; }
.toolbar button {
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 6px;
  padding: 6px 14px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}
.toolbar button:hover { opacity: 0.9; }
.toolbar button.secondary {
  background: var(--surface);
  color: var(--fg);
  border: 1px solid var(--border);
}
.tabs {
  display: flex;
  gap: 0;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
.tab {
  padding: 8px 16px;
  font-size: 13px;
  cursor: pointer;
  border-right: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}
.tab:hover { background: rgba(255,255,255,0.05); }
.tab.active { background: var(--bg); border-bottom: 2px solid var(--accent); }
.tab .close {
  font-size: 11px;
  color: #666;
  cursor: pointer;
  padding: 0 2px;
}
.tab .close:hover { color: #e53935; }
.editor-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.line-numbers {
  padding: 16px 12px;
  text-align: right;
  color: #555;
  font-size: 13px;
  line-height: 1.6;
  user-select: none;
  background: var(--surface);
  border-right: 1px solid var(--border);
  min-width: 48px;
  overflow: hidden;
}
.code-container {
  flex: 1;
  display: flex;
  overflow: auto;
}
textarea.code {
  flex: 1;
  background: var(--bg);
  color: var(--fg);
  border: none;
  padding: 16px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.6;
  resize: none;
  tab-size: 2;
  white-space: pre;
  overflow-wrap: normal;
}
textarea.code:focus { outline: none; }
.status-bar {
  display: flex;
  justify-content: space-between;
  padding: 4px 16px;
  font-size: 12px;
  color: #666;
  border-top: 1px solid var(--border);
  background: var(--surface);
}
.empty-state {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  flex-direction: column;
  gap: 8px;
}
</style>
</head>
<body>
<div class="toolbar">
  <input type="text" id="filePath" placeholder="File path (e.g. apps/todo.html)" value="">
  <button id="openBtn">Open</button>
  <button id="saveBtn" class="secondary">Save</button>
  <button id="newBtn" class="secondary">New</button>
</div>
<div class="tabs" id="tabs"></div>
<div class="editor-area" id="editorArea">
  <div class="empty-state">
    <div>Open a file to start editing</div>
    <div style="font-size:12px">Enter a path relative to your home directory</div>
  </div>
</div>
<div class="status-bar">
  <span id="statusLeft">Ready</span>
  <span id="statusRight"></span>
</div>

<script>
var GATEWAY = location.origin;
var openFiles = [];
var activeTab = null;

document.getElementById('openBtn').addEventListener('click', openFile);
document.getElementById('saveBtn').addEventListener('click', saveFile);
document.getElementById('newBtn').addEventListener('click', newFile);
document.getElementById('filePath').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') openFile();
});

function openFile() {
  var path = document.getElementById('filePath').value.trim();
  if (!path) return;

  var existing = openFiles.find(function(f) { return f.path === path; });
  if (existing) {
    activeTab = path;
    renderTabs();
    renderEditor();
    return;
  }

  document.getElementById('statusLeft').textContent = 'Loading...';

  fetch(GATEWAY + '/files/' + path)
    .then(function(r) {
      if (!r.ok) throw new Error('File not found');
      return r.text();
    })
    .then(function(content) {
      openFiles.push({ path: path, content: content, modified: false });
      activeTab = path;
      renderTabs();
      renderEditor();
      document.getElementById('statusLeft').textContent = 'Opened: ' + path;
    })
    .catch(function(err) {
      document.getElementById('statusLeft').textContent = 'Error: ' + err.message;
    });
}

function newFile() {
  var path = document.getElementById('filePath').value.trim() || 'untitled.txt';
  var existing = openFiles.find(function(f) { return f.path === path; });
  if (existing) {
    activeTab = path;
  } else {
    openFiles.push({ path: path, content: '', modified: true });
    activeTab = path;
  }
  renderTabs();
  renderEditor();
  document.getElementById('statusLeft').textContent = 'New file: ' + path;
}

function saveFile() {
  var file = openFiles.find(function(f) { return f.path === activeTab; });
  if (!file) return;

  document.getElementById('statusLeft').textContent = 'Saving...';

  fetch(GATEWAY + '/api/bridge/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'write', app: 'code-editor', key: 'file:' + file.path, value: file.content })
  })
  .then(function() {
    file.modified = false;
    renderTabs();
    document.getElementById('statusLeft').textContent = 'Saved: ' + file.path;
  })
  .catch(function() {
    document.getElementById('statusLeft').textContent = 'Save failed';
  });
}

function closeTab(path) {
  openFiles = openFiles.filter(function(f) { return f.path !== path; });
  if (activeTab === path) {
    activeTab = openFiles.length > 0 ? openFiles[openFiles.length - 1].path : null;
  }
  renderTabs();
  renderEditor();
}

function selectTab(path) {
  activeTab = path;
  renderTabs();
  renderEditor();
}

function renderTabs() {
  var tabsEl = document.getElementById('tabs');
  tabsEl.replaceChildren();

  openFiles.forEach(function(f) {
    var tab = document.createElement('div');
    tab.className = 'tab' + (f.path === activeTab ? ' active' : '');
    tab.addEventListener('click', function() { selectTab(f.path); });

    var label = document.createElement('span');
    label.textContent = f.path.split('/').pop() + (f.modified ? ' *' : '');
    tab.appendChild(label);

    var close = document.createElement('span');
    close.className = 'close';
    close.textContent = 'x';
    close.addEventListener('click', function(e) {
      e.stopPropagation();
      closeTab(f.path);
    });
    tab.appendChild(close);

    tabsEl.appendChild(tab);
  });
}

function renderEditor() {
  var area = document.getElementById('editorArea');
  area.replaceChildren();

  var file = openFiles.find(function(f) { return f.path === activeTab; });
  if (!file) {
    var empty = document.createElement('div');
    empty.className = 'empty-state';
    var msg1 = document.createElement('div');
    msg1.textContent = 'Open a file to start editing';
    var msg2 = document.createElement('div');
    msg2.style.fontSize = '12px';
    msg2.textContent = 'Enter a path relative to your home directory';
    empty.appendChild(msg1);
    empty.appendChild(msg2);
    area.appendChild(empty);
    document.getElementById('statusRight').textContent = '';
    return;
  }

  document.getElementById('filePath').value = file.path;

  var container = document.createElement('div');
  container.className = 'code-container';

  var lineNums = document.createElement('div');
  lineNums.className = 'line-numbers';
  lineNums.id = 'lineNums';
  container.appendChild(lineNums);

  var textarea = document.createElement('textarea');
  textarea.className = 'code';
  textarea.value = file.content;
  textarea.spellcheck = false;
  textarea.addEventListener('input', function() {
    file.content = textarea.value;
    file.modified = true;
    renderTabs();
    updateLineNumbers(textarea, lineNums);
    updateStatus(textarea);
  });
  textarea.addEventListener('scroll', function() {
    lineNums.scrollTop = textarea.scrollTop;
  });
  textarea.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + 2;
      file.content = textarea.value;
      file.modified = true;
      renderTabs();
    }
    if (e.key === 's' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      saveFile();
    }
  });
  container.appendChild(textarea);

  area.appendChild(container);
  updateLineNumbers(textarea, lineNums);
  updateStatus(textarea);
  textarea.focus();
}

function updateLineNumbers(textarea, lineNums) {
  var lines = textarea.value.split('\n').length;
  var nums = [];
  for (var i = 1; i <= lines; i++) nums.push(String(i));
  lineNums.textContent = nums.join('\n');
}

function updateStatus(textarea) {
  var val = textarea.value;
  var lines = val.split('\n').length;
  var pos = textarea.selectionStart;
  var lineNum = val.substring(0, pos).split('\n').length;
  var col = pos - val.lastIndexOf('\n', pos - 1);
  document.getElementById('statusRight').textContent = 'Ln ' + lineNum + ', Col ' + col + ' | ' + lines + ' lines';
}
</script>
</body>
</html>
