# Module Standard

## What Is a Module?
A module is a self-contained application directory in `~/modules/` with its own manifest and entry point. Modules are either **static-built** (pre-compiled, no server) or **server-based** (runs a process on a port).

## Module Types

### Static-Built (default)
Pre-built apps (React/Vite) compiled to static HTML/CSS/JS. Served directly by the gateway via `/files/`. No running process needed.

- Entry point: `dist/index.html` (Vite build output)
- No port, no health check
- Fastest to load, zero runtime overhead

### Server-Based
Apps that run their own HTTP server (APIs, WebSocket services, etc). The gateway reverse-proxies to their port.

- Entry point: server process (Node.js)
- Requires port (3100-3999 range) and health endpoint
- Health-checked by heartbeat every 30s

## Required Files

### All Modules
- `module.json` -- Matrix OS metadata (name, description, version, entry)

### Static-Built Modules (React)
- `package.json` -- dependencies and build scripts
- `vite.config.ts` -- Vite configuration
- `tsconfig.json` -- TypeScript configuration
- `index.html` -- Vite entry point
- `src/` -- source code
- `dist/` -- build output (generated by `pnpm build`)

### Server-Based Modules
- `manifest.json` -- includes port and health endpoint
- Server entry file (e.g., `server.ts`)
- `package.json` -- dependencies

## module.json Schema (Static-Built)
```json
{
  "name": "string (kebab-case)",
  "description": "string",
  "version": "string (semver)",
  "entry": "dist/index.html"
}
```

## manifest.json Schema (Server-Based)
```json
{
  "name": "string (kebab-case)",
  "version": "string (semver)",
  "description": "string",
  "entryPoint": "string (relative path)",
  "port": "number (3100-3999 range)",
  "health": "string (health check path, e.g. /health)",
  "dependencies": ["string[] (other module names)"],
  "data": "string (data directory path, optional)"
}
```

## Port Allocation (Server-Based Only)
- Modules use ports 3100-3999
- Each server module gets a unique port assigned at creation
- The gateway proxies `localhost:GATEWAY_PORT/modules/<name>/` to the module's port
- Check existing modules.json to avoid port conflicts

## Health Checks (Server-Based Only)
- Every server module MUST expose a health endpoint
- `GET /health` returns `200 OK` when healthy
- The heartbeat agent pings this every 30 seconds
- 3 consecutive failures trigger the healer agent

## Data Isolation
- Module data goes in `~/data/<module-name>/`
- Modules can read shared data from `~/data/shared/`
- Cross-module data flow: one module writes to `~/data/shared/`, another reads

## Registration
After creating a module, append to `~/system/modules.json`:

### Static-Built
```json
{
  "name": "module-name",
  "type": "react-app",
  "path": "~/modules/module-name",
  "status": "active"
}
```

### Server-Based
```json
{
  "name": "module-name",
  "type": "module",
  "path": "~/modules/module-name/",
  "port": 3100,
  "status": "running",
  "createdAt": "ISO timestamp"
}
```
