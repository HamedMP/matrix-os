# Local multi-instance testing
# Usage: docker compose -f distro/docker-compose.local.yml up --build
#
# Access:
#   Alice shell:  http://localhost:3001
#   Bob shell:    http://localhost:3002
#   Proxy admin:  http://localhost:8080
#
# Test cross-instance messaging:
#   curl http://localhost:8080/send/bob \
#     -H "content-type: application/json" \
#     -d '{"text":"Hello Bob!","from":{"handle":"alice","displayName":"Alice"}}'

services:
  proxy:
    build:
      context: ..
      dockerfile: Dockerfile
    command: ["node", "--import=tsx", "packages/proxy/src/main.ts"]
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PROXY_PORT=8080
      - PROXY_DB_PATH=/data/proxy.db
    ports:
      - "8080:8080"
    volumes:
      - proxy-data:/data
    networks:
      - matrixos-net
    healthcheck:
      test: wget -qO- http://localhost:8080/health || exit 1
      interval: 10s
      timeout: 3s
      start_period: 5s

  alice:
    build:
      context: ..
      dockerfile: Dockerfile
    environment:
      - ANTHROPIC_BASE_URL=http://proxy:8080
      - MATRIX_HANDLE=alice
      - PROXY_URL=http://proxy:8080
      - GATEWAY_EXTERNAL_URL=http://alice:4000
      - SHELL_PORT=3000
    ports:
      - "3001:3000"
      - "4001:4000"
    volumes:
      - alice-home:/home/matrixos/home
    networks:
      - matrixos-net
    depends_on:
      proxy:
        condition: service_healthy

  bob:
    build:
      context: ..
      dockerfile: Dockerfile
    environment:
      - ANTHROPIC_BASE_URL=http://proxy:8080
      - MATRIX_HANDLE=bob
      - PROXY_URL=http://proxy:8080
      - GATEWAY_EXTERNAL_URL=http://bob:4000
      - SHELL_PORT=3000
    ports:
      - "3002:3000"
      - "4002:4000"
    volumes:
      - bob-home:/home/matrixos/home
    networks:
      - matrixos-net
    depends_on:
      proxy:
        condition: service_healthy

volumes:
  proxy-data:
  alice-home:
  bob-home:

networks:
  matrixos-net:
