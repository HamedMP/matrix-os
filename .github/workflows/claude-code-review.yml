name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this PR. Focus on:
            1. Bugs, logic errors, and potential runtime failures
            2. Security vulnerabilities (XSS, injection, auth issues)
            3. Performance problems (memory leaks, unnecessary re-renders, N+1 queries)
            4. Code quality and adherence to project conventions in CLAUDE.md

            Be concise. Only flag real issues, not style nitpicks.
            Use the gh CLI to read the PR diff and post inline comments on specific lines.
          claude_args: |
            --max-turns 10
            --allowedTools "Bash(gh pr:*),Bash(gh api:*),Read,Glob,Grep"
